<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>IIS Logs Bar Chart Race</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: sans-serif; }
    .bar { fill-opacity: 0.7; }
    .label { font-size: 14px; fill: #333; }
    .axis text { font-size: 12px; }
  </style>
</head>
<body>
  <h2>Clicks per User Over Time</h2>
  <svg id="chart" width="800" height="500"></svg>

  <script>
  const svg = d3.select("#chart"),
        width = +svg.attr("width"),
        height = +svg.attr("height"),
        margin = {top: 40, right: 20, bottom: 40, left: 150};

  const chartWidth = width - margin.left - margin.right,
        chartHeight = height - margin.top - margin.bottom;

  const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  let x = d3.scaleLinear().range([0, chartWidth]);
  let y = d3.scaleBand().range([0, chartHeight]).padding(0.1);

  d3.json("iis_clicks.json").then(data => {
    // Parse time
    data.forEach(d => { d.period = new Date(d.period); });

    // Nest by period
    const periods = Array.from(d3.group(data, d => d.period), ([key, value]) => ({period: key, values: value}));
    periods.sort((a,b) => d3.ascending(a.period, b.period));

    let i = 0;
    function updateFrame() {
      if (i >= periods.length) return;
      const frame = periods[i];
      const users = frame.values.sort((a,b) => b.clicks - a.clicks).slice(0, 10);

      x.domain([0, d3.max(users, d => d.clicks)]);
      y.domain(users.map(d => d["cs-username"]));

      // Join
      const bars = g.selectAll(".bar").data(users, d => d["cs-username"]);

      bars.enter().append("rect")
          .attr("class", "bar")
          .attr("y", d => y(d["cs-username"]))
          .attr("height", y.bandwidth())
          .attr("x", 0)
          .attr("width", d => x(d.clicks))
          .style("fill", "steelblue")
        .merge(bars)
          .transition().duration(800)
          .attr("y", d => y(d["cs-username"]))
          .attr("width", d => x(d.clicks));

      bars.exit().remove();

      // Labels
      const labels = g.selectAll(".label").data(users, d => d["cs-username"]);

      labels.enter().append("text")
          .attr("class", "label")
          .attr("y", d => y(d["cs-username"]) + y.bandwidth()/2 + 4)
          .attr("x", d => x(d.clicks) + 5)
          .text(d => d["cs-username"] + " (" + d.clicks + ")")
        .merge(labels)
          .transition().duration(800)
          .attr("y", d => y(d["cs-username"]) + y.bandwidth()/2 + 4)
          .attr("x", d => x(d.clicks) + 5)
          .text(d => d["cs-username"] + " (" + d.clicks + ")");

      labels.exit().remove();

      // Period title
      const periodLabel = svg.selectAll(".periodLabel").data([frame.period]);
      periodLabel.enter().append("text")
          .attr("class", "periodLabel")
          .attr("x", width/2)
          .attr("y", margin.top/2)
          .attr("text-anchor", "middle")
          .style("font-size", "20px")
        .merge(periodLabel)
          .text(d3.timeFormat("%Y-%m-%d")(frame.period));

      i++;
      setTimeout(updateFrame, 1200);
    }

    updateFrame();
  });
  </script>
</body>
</html>
