WITH with_lags AS (
  SELECT 
    dateid,
    timeid,
    LAG(timeid) OVER (PARTITION BY dateid ORDER BY timeid) AS prev_timeid
  FROM your_table
),
missing_intervals AS (
  SELECT 
    dateid,
    CASE 
      WHEN prev_timeid IS NULL THEN 0
      WHEN timeid - prev_timeid > 300 
        THEN FLOOR((timeid - prev_timeid) / 300.0) - 1
      ELSE 0
    END AS missing_count
  FROM with_lags
),
summary AS (
  SELECT 
    dateid,
    SUM(missing_count) AS total_missing_intervals,
    COUNT(*) AS actual_samples,
    288 AS expected_samples,  -- 86400 / 300
    288 - SUM(missing_count) AS estimated_present_intervals,
    ROUND(100.0 * (288 - SUM(missing_count)) / 288, 2) AS coverage_percent
  FROM missing_intervals
  GROUP BY dateid
)
SELECT * FROM summary
ORDER BY dateid;
